#+TITLE: Let It Be Lambda (λ)
#+AUTHOR: Gerd Heber
#+EMAIL: gheber@hdfgroup.org
#+DATE: 08 January 2021
#+STARTUP: overview

#+LATEX_COMPILER: xelatex
#+LATEX_CLASS: article
#+LATEX_CLASS_OPTIONS: [a4paper, 12pt]
#+LATEX_HEADER: \usepackage[a4paper,top=1cm,bottom=1cm,left=1cm,right=1cm]{geometry}

#+PROPERTY: header-args :eval never-export

*Book recommendation:* [[https://letoverlambda.com/][Let Over Lambda—50 Years of Lisp]] by [[https://hoytech.com/about][Doug Hoyte]]

* TODO Peculiarities of Org-Mode C Code Blocks
*  Lambda Helper

We've wrapped standard headers and macros into a single header file called [[file:./src/literate-hdf5.h][literate-hdf5.h]].

#+header: :main no
#+begin_src C -r -n :tangle src/literate-hdf5.h :noweb yes :exports none
#ifndef LITERATE_HDF5_H
#define LITERATE_HDF5_H

<<boilerplate>>

#endif
#+end_src

These are the standard header files included.

#+begin_src C :noweb-ref boilerplate

#include "hdf5.h"

#include <stdio.h>
#include <stdlib.h>

#+end_src

The more interesting bit is the =lambda= macro by [[https://hackaday.com/2019/09/11/lambdas-for-c-sort-of/][Al Williams]].

#+begin_src C -n :noweb-ref boilerplate

#define lambda(lambda$_ret, lambda$_args, lambda$_body) \
  ({                                                    \
    lambda$_ret lambda$__anon$ lambda$_args             \
      lambda$_body                                      \
      &lambda$__anon$;                                  \
  })

  #+end_src

It uses two features of GNU C (=--std=gnu99=), namely, [[http://gcc.gnu.org/onlinedocs/gcc/Nested-Functions.html][nested functions]] and
[[https://gcc.gnu.org/onlinedocs/gcc/Statement-Exprs.html][statement expressions]], which lets us wrap C code blocks as "lambda functions",
thereby making longer pieces of code easier to follow and digest.

#+begin_example

lambda(<return type>, ([type1 arg1, type2 arg2, ...]), { <lambda body>  })

#+end_example

Such a =lambda= can then be invoked like a C-function pointer:

#+header: :flags "-I./src" :libs "-lhdf5"
#+begin_src C -r -n :tangle src/lambda.c :exports both

#include "literate-hdf5.h"

int main()
{
  unsigned majnum, minnum, relnum;
  H5get_libversion(&majnum, &minnum, &relnum);

  printf
    ("%f\n",
     (*lambda(float, (float x), { return x*x; })) (majnum+minnum+relnum)
     );

  return 0;
}

#+end_src

#+RESULTS:
: 196.0

* COMMENT Local Variables

# Local Variables:
# org-coderef-label-format: "// (ref:%s)"
# End:
